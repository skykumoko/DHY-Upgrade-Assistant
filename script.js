const ResourceTracker = (() => {
    // ÈÖçÁΩÆÈ°π
    const config = {
        containerId: '#resourceTracker',
        elements: {
            classStatus: '#classStatus',
            materialsList: '#materials-list',
            moneyCheck: '#money-check',
            fragments: '#fragments',
            scrolls: '#scrolls',
            expStatus: '#exp-status',
            lastUpdated: '#lastUpdated',
            resetButton: '#resetButton'
        },
        storageKey: 'DHY-Upgrade-Assistant_v1',
        gistToken: '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', // GitHub‰∏™‰∫∫ËÆøÈóÆ‰ª§Áâå
        gistId: null, // Á¨¨‰∏ÄÊ¨°ËøêË°åÊó∂Ëá™Âä®ÂàõÂª∫
        gistFilename: 'DHY-Upgrade-Assistant-data.json'
    };

    // ÊùêÊñôÊï∞ÊçÆ
    const materialsData = [
        // 80Á∫ßÁ™ÅÁ†¥ÊùêÊñô
        { id: 'fujunhaitang', name: '„ÄêÂ∫úÂêõÊµ∑Ê£†„Äë*30', class: 'ËØ°ÈÅì' },
        { id: 'panlonggu', name: '„ÄêËü†ÈæôÈºì„Äë*30', class: 'Á•ûÁ∫™' },
        { id: 'yinwendao', name: '„ÄêÈì∂Á∫πÂàÄ„Äë*30', class: 'Â≤êÈªÑ' },
        { id: 'yuguidun', name: '„ÄêÁéâÈæüÁõæ„Äë*30', class: 'ÈæôÁõæ' },
        { id: 'xijiaogong', name: '„ÄêÁäÄËßíÂºì„Äë*30', class: 'Á†¥ÂÜõ' },
        // 70Á∫ßÁ™ÅÁ†¥ÊùêÊñô
        { id: 'menghunlan', name: '„ÄêÊ¢¶È≠ÇÂÖ∞„Äë*30', class: 'ËØ°ÈÅì' },
        { id: 'zhentiangu', name: '„ÄêÈúáÂ§©Èºì„Äë*30', class: 'Á•ûÁ∫™' },
        { id: 'qingtongdao', name: '„ÄêÈùíÈìúÂàÄ„Äë*30', class: 'Â≤êÈªÑ' },
        { id: 'caiwendun', name: '„ÄêÂΩ©Á∫πÁõæ„Äë*30', class: 'ÈæôÁõæ' },
        { id: 'tietaigong', name: '„ÄêÈìÅËÉéÂºì„Äë*30', class: 'Á†¥ÂÜõ' },
        // ÈÄöÁî®ÂçáÁ∫ßÊùêÊñô
        { id: 'zuigucao', name: '„ÄêÈÜâÈ™®Ëçâ„Äë*30', class: 'ÈÄöÁî®' },
        { id: 'qingtingyan', name: '„ÄêËúªËúìÁúº„Äë*120', class: 'ÈÄöÁî®' },
        { id: 'ziyunying', name: '„ÄêÁ¥´‰∫ëËã±„Äë*160', class: 'ÈÄöÁî®' },
        { id: 'yingqiongyao', name: '„ÄêÁëõÁêºÁë∂„Äë*105', class: 'ÈÄöÁî®' },
        { id: 'jincuodao', name: '„ÄêÈáëÈîôÂàÄ„Äë*80', class: 'ÈÄöÁî®' },
        { id: 'diguanghe', name: '„Äê‰ΩéÂÖâËç∑„Äë*100', class: 'ÈÄöÁî®' },
        { id: 'yuanyu', name: '„ÄêÈ∏¢ÁæΩ„Äë*40', class: 'ÈÄöÁî®' },
        { id: 'jianjia', name: '„ÄêËíπËë≠„Äë*494', class: 'ÈÄöÁî®' }
    ];
    
    // ËÅå‰∏öÊï∞ÊçÆ
    const classes = ['ËØ°ÈÅì', 'Á•ûÁ∫™', 'Â≤êÈªÑ', 'ÈæôÁõæ', 'Á†¥ÂÜõ'];
    const requiredExp = 2386300; // ÊâÄÈúÄÁªèÈ™åÂÄº
    
    const dom = {}; // DOMÂÖÉÁ¥†ÁºìÂ≠ò
    let state = {}; // Â∫îÁî®Áä∂ÊÄÅ

    // Ê†ºÂºèÂåñÊó•Êúü‰∏∫‰∏≠ÊñáÊòæÁ§∫
    const formatDate = (date) => {
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/\//g, '-');
    };

    // Êõ¥Êñ∞Êó∂Èó¥Êà≥ÊòæÁ§∫
    const updateTimestamp = () => {
        const now = new Date();
        state.lastUpdated = now.toISOString();
        dom.lastUpdated.textContent = `ÊúÄËøëÊõ¥Êñ∞Ôºö${formatDate(now)}`;
    };

    // ËÆ°ÁÆóÁªèÈ™åÂÄºÁä∂ÊÄÅÔºà‰∏ç‰æùËµñDOMÔºâ
    const getExpStatus = () => {
        const currentExp = state.fragments * 100 + state.scrolls * 1000;
        return {
            isMet: currentExp >= requiredExp,
            text: currentExp >= requiredExp ? 'Â∑≤Êª°Ë∂≥' : 'Êú™Êª°Ë∂≥',
            className: currentExp >= requiredExp ? 'exp-status met' : 'exp-status not-met'
        };
    };

    // ÂàùÂßãÂåñÂ∫îÁî®
    const init = () => {
        console.log('üöÄ ÂØÜÊé¢ËµÑÊ∫êÁ≥ªÁªüÂêØÂä®...');
        
        try {
            // ÁºìÂ≠òDOMÂÖÉÁ¥†
            dom.container = document.querySelector(config.containerId);
            Object.entries(config.elements).forEach(([key, selector]) => {
                dom[key] = document.querySelector(selector);
            });

            // Âä†ËΩΩÊï∞ÊçÆÂêéÂàùÂßãÂåñ
            loadData().then(() => {
                bindEvents();
                render();
            });
        } catch (error) {
            showError('Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
            console.error('ÂàùÂßãÂåñÈîôËØØ:', error);
        }
    };
    
    // Âä†ËΩΩ‰øùÂ≠òÁöÑÊï∞ÊçÆ
    const loadData = async () => {
        try {
            // Â∞ùËØï‰ªéGitHub GistÂä†ËΩΩ
            const savedGistId = localStorage.getItem('gistId');
            if (savedGistId) config.gistId = savedGistId;
            
            if (config.gistId && config.gistToken) {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.gistToken}`
                    }
                });
                
                const data = await response.json();
                if (data.files?.[config.gistFilename]) {
                    state = JSON.parse(data.files[config.gistFilename].content);
                }
            }
            
            // ÂõûÈÄÄÂà∞Êú¨Âú∞Â≠òÂÇ®
            if (!state || Object.keys(state).length === 0) {
                const saved = localStorage.getItem(config.storageKey);
                state = saved ? JSON.parse(saved) : resetSystem();
            }

            // ÊÅ¢Â§çÊó∂Èó¥Êà≥ÊòæÁ§∫
            if (state.lastUpdated) {
                dom.lastUpdated.textContent = `ÊúÄËøëÊõ¥Êñ∞Ôºö${formatDate(new Date(state.lastUpdated))}`;
            }
        } catch (e) {
            console.warn('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', e);
            const saved = localStorage.getItem(config.storageKey);
            state = saved ? JSON.parse(saved) : resetSystem();
        }
    };
    
    // ÈáçÁΩÆÁ≥ªÁªüÁä∂ÊÄÅ
    const resetSystem = () => {
        state = {
            moneyChecked: false,
            fragments: 0,
            scrolls: 0,
            materials: {},
            lastUpdated: new Date().toISOString()
        };
        
        // ÂàùÂßãÂåñÊùêÊñôÁä∂ÊÄÅ
        materialsData.forEach(material => {
            state.materials[material.id] = false;
        });
        
        return state;
    };

    // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨
    const bindEvents = () => {
        // ÈáëÈí±Â§çÈÄâÊ°Ü
        dom.moneyCheck.addEventListener('change', () => {
            state.moneyChecked = dom.moneyCheck.checked;
            updateTimestamp();
            saveAndRender();
        });
        
        // ÂÖµ‰π¶Êï∞ÈáèËæìÂÖ•
        dom.fragments.addEventListener('input', () => {
            state.fragments = parseInt(dom.fragments.value) || 0;
            updateTimestamp();
            saveAndRender();
        });
        
        dom.scrolls.addEventListener('input', () => {
            state.scrolls = parseInt(dom.scrolls.value) || 0;
            updateTimestamp();
            saveAndRender();
        });
        
        // ÊùêÊñôÂ§çÈÄâÊ°ÜÔºà‰∫ã‰ª∂ÂßîÊâòÔºâ
        dom.materialsList.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const materialId = e.target.id.replace('-check', '');
                state.materials[materialId] = e.target.checked;
                updateTimestamp();
                saveAndRender();
            }
        });

        // Ê∏ÖÁ©∫ÊåâÈíÆ
        dom.resetButton.addEventListener('click', () => {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËÆ∞ÂΩïÂêóÔºü')) {
                resetSystem();
                updateTimestamp();
                saveAndRender();
            }
        });
    };

    // Ê∏≤ÊüìÊï¥‰∏™ÁïåÈù¢
    const render = () => {
        // ËÆ°ÁÆóÂΩìÂâçÁä∂ÊÄÅ
        const expStatus = getExpStatus();
        const generalMaterials = materialsData.filter(m => m.class === 'ÈÄöÁî®');
        const allGeneralMet = generalMaterials.every(m => state.materials[m.id]);
        const baseConditionsMet = state.moneyChecked && expStatus.isMet && allGeneralMet;

        // Êõ¥Êñ∞DOMÊòæÁ§∫
        dom.expStatus.textContent = expStatus.text;
        dom.expStatus.className = expStatus.className;
        dom.moneyCheck.checked = state.moneyChecked;
        dom.fragments.value = state.fragments;
        dom.scrolls.value = state.scrolls;

        // Ê∏≤ÊüìËÅå‰∏öÁä∂ÊÄÅ
        dom.classStatus.innerHTML = classes.map(className => {
            const classMaterials = materialsData.filter(m => m.class === className);
            const allClassMaterialsMet = classMaterials.every(m => state.materials[m.id]);
            const isReady = baseConditionsMet && allClassMaterialsMet;
            
            return `
                <div class="class-row">
                    <div class="class-name">${className}</div>
                    <div class="class-indicator ${isReady ? 'ready' : 'pending'}">
                        ${isReady ? 'ÂèØÊª°Á∫ß' : 'ÂæÖÊ≤âÊ∑Ä'}
                    </div>
                </div>
            `;
        }).join('');

        // Ê∏≤ÊüìÊùêÊñôÂàóË°®
        dom.materialsList.innerHTML = materialsData.map(material => `
            <div class="resource-item">
                <div class="resource-name">${material.name}</div>
                <div class="checkbox-container">
                    <input type="checkbox" id="${material.id}-check" ${state.materials[material.id] ? 'checked' : ''}>
                </div>
            </div>
        `).join('');
    };

    // ‰øùÂ≠òÂπ∂ÈáçÊñ∞Ê∏≤Êüì
    const saveAndRender = () => {
        saveData();
        render();
    };

    // ‰øùÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞ÂíåGitHub
    const saveData = async () => {
        try {
            // Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem(config.storageKey, JSON.stringify(state));
            
            // GitHub GistÂ≠òÂÇ®
            if (!config.gistToken) return;
            
            const url = config.gistId 
                ? `https://api.github.com/gists/${config.gistId}` 
                : 'https://api.github.com/gists';
                
            const response = await fetch(url, {
                method: config.gistId ? 'PATCH' : 'POST',
                headers: {
                    'Authorization': `token ${config.gistToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    description: 'Secret Agent Resources Data',
                    public: false,
                    files: {
                        [config.gistFilename]: {
                            content: JSON.stringify(state)
                        }
                    }
                })
            });
            
            // ‰øùÂ≠òGist ID
            if (!config.gistId) {
                const data = await response.json();
                config.gistId = data.id;
                localStorage.setItem('gistId', data.id);
            }
        } catch (e) {
            console.error('‰øùÂ≠òÂ§±Ë¥•:', e);
            localStorage.setItem(config.storageKey, JSON.stringify(state));
        }
    };

    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
    const showError = (msg) => {
        dom.container.innerHTML = `
            <div class="error-box">
                ‚ùó ${msg}
                <button onclick="location.reload()">ÁÇπÂáªÈáçËØï</button>
            </div>
        `;
    };

    return { init };
})();

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂêØÂä®Â∫îÁî®
document.addEventListener('DOMContentLoaded', ResourceTracker.init);
