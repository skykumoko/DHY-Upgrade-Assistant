const ResourceTracker = (() => {
    const config = {
        containerId: '#resourceTracker',
        elements: {
            classStatus: '#classStatus',
            materialsList: '#materials-list',
            moneyCheck: '#money-check',
            fragments: '#fragments',
            scrolls: '#scrolls',
            expStatus: '#exp-status'
        },
        storageKey: 'DHY-Upgrade-Assistant_v1',
        gistToken: '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', // GitHubä¸ªäººè®¿é—®ä»¤ç‰Œ
        gistId: null, // ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»º
        gistFilename: 'DHY-Upgrade-Assistant-data.json'
    };

    // ææ–™æ•°æ® - ç®€åŒ–ç‰ˆ
    const materialsData = [
        // 80çº§çªç ´ææ–™
        { id: 'fujunhaitang', name: 'ã€åºœå›æµ·æ£ ã€‘*30', class: 'è¯¡é“' },
        { id: 'panlonggu', name: 'ã€èŸ é¾™é¼“ã€‘*30', class: 'ç¥çºª' },
        { id: 'yinwendao', name: 'ã€é“¶çº¹åˆ€ã€‘*30', class: 'å²é»„' },
        { id: 'yuguidun', name: 'ã€ç‰é¾Ÿç›¾ã€‘*30', class: 'é¾™ç›¾' },
        { id: 'xijiaogong', name: 'ã€çŠ€è§’å¼“ã€‘*30', class: 'ç ´å†›' },
        // 70çº§çªç ´ææ–™
        { id: 'menghunlan', name: 'ã€æ¢¦é­‚å…°ã€‘*30', class: 'è¯¡é“' },
        { id: 'zhentiangu', name: 'ã€éœ‡å¤©é¼“ã€‘*30', class: 'ç¥çºª' },
        { id: 'qingtongdao', name: 'ã€é’é“œåˆ€ã€‘*30', class: 'å²é»„' },
        { id: 'caiwendun', name: 'ã€å½©çº¹ç›¾ã€‘*30', class: 'é¾™ç›¾' },
        { id: 'tietaigong', name: 'ã€é“èƒå¼“ã€‘*30', class: 'ç ´å†›' },
        // é€šç”¨1-100çº§å‡çº§ææ–™
        { id: 'zuigucao', name: 'ã€é†‰éª¨è‰ã€‘*30', class: 'é€šç”¨' },
        { id: 'qingtingyan', name: 'ã€èœ»èœ“çœ¼ã€‘*120', class: 'é€šç”¨' },
        { id: 'ziyunying', name: 'ã€ç´«äº‘è‹±ã€‘*160', class: 'é€šç”¨' },
        { id: 'yingqiongyao', name: 'ã€ç‘›ç¼ç‘¶ã€‘*105', class: 'é€šç”¨' },
        { id: 'jincuodao', name: 'ã€é‡‘é”™åˆ€ã€‘*80', class: 'é€šç”¨' },
        { id: 'diguanghe', name: 'ã€ä½å…‰è·ã€‘*100', class: 'é€šç”¨' },
        { id: 'yuanyu', name: 'ã€é¸¢ç¾½ã€‘*40', class: 'é€šç”¨' },
        { id: 'jianjia', name: 'ã€è’¹è‘­ã€‘*494', class: 'é€šç”¨' }
    ];
    
    // èŒä¸šæ•°æ®
    const classes = ['è¯¡é“', 'ç¥çºª', 'å²é»„', 'é¾™ç›¾', 'ç ´å†›'];
    const requiredExp = 2386300;
    
    const dom = {};
    let state = {};

    const init = () => {
        console.log('ğŸš€ å¯†æ¢èµ„æºç³»ç»Ÿå¯åŠ¨...');
        
        try {
            // ç¼“å­˜DOMå…ƒç´ 
            dom.container = document.querySelector(config.containerId);
            dom.classStatus = document.querySelector(config.elements.classStatus);
            dom.materialsList = document.querySelector(config.elements.materialsList);
            dom.moneyCheck = document.querySelector(config.elements.moneyCheck);
            dom.fragments = document.querySelector(config.elements.fragments);
            dom.scrolls = document.querySelector(config.elements.scrolls);
            dom.expStatus = document.querySelector(config.elements.expStatus);

            loadData();
            bindEvents();
            render();
        } catch (error) {
            showError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        }
    };

    const loadData = async () => {
        try {
            const savedGistId = localStorage.getItem('gistId');
            if (savedGistId) config.gistId = savedGistId;
            
            if (config.gistId && config.gistToken) {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.gistToken}`
                    }
                });
                
                const data = await response.json();
                if (data.files && data.files[config.gistFilename]) {
                    state = JSON.parse(data.files[config.gistFilename].content);
                    return;
                }
            }
            
            // å›é€€åˆ°æœ¬åœ°å­˜å‚¨
            const saved = localStorage.getItem(config.storageKey);
            if (saved) {
                state = JSON.parse(saved);
            } else {
                resetSystem();
            }
        } catch (e) {
            console.warn('ä»GiståŠ è½½å¤±è´¥:', e);
            const saved = localStorage.getItem(config.storageKey);
            if (saved) {
                state = JSON.parse(saved);
            } else {
                resetSystem();
            }
        }
    };
    
    const resetSystem = () => {
        state = {
            moneyChecked: false,
            fragments: 0,
            scrolls: 0,
            materials: {}
        };
        
        // åˆå§‹åŒ–æ‰€æœ‰ææ–™ä¸ºæœªé€‰ä¸­
        materialsData.forEach(material => {
            state.materials[material.id] = false;
        });
    };

    const bindEvents = () => {
        // é‡‘é’±å¤é€‰æ¡†
        dom.moneyCheck.addEventListener('change', () => {
            state.moneyChecked = dom.moneyCheck.checked;
            saveAndRender();
        });
        
        // å…µä¹¦è¾“å…¥
        dom.fragments.addEventListener('input', () => {
            state.fragments = parseInt(dom.fragments.value) || 0;
            updateExpStatus();
            saveAndRender();
        });
        
        dom.scrolls.addEventListener('input', () => {
            state.scrolls = parseInt(dom.scrolls.value) || 0;
            updateExpStatus();
            saveAndRender();
        });
        
        // ææ–™å¤é€‰æ¡†ï¼ˆå§”æ‰˜äº‹ä»¶ï¼‰
        dom.materialsList.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const materialId = e.target.id.replace('-check', '');
                state.materials[materialId] = e.target.checked;
                saveAndRender();
            }
        });
    };

    const updateExpStatus = () => {
        const currentExp = state.fragments * 100 + state.scrolls * 1000;
        
        if (currentExp >= requiredExp) {
            dom.expStatus.textContent = 'å·²æ»¡è¶³';
            dom.expStatus.className = 'exp-status met';
        } else {
            dom.expStatus.textContent = 'æœªæ»¡è¶³';
            dom.expStatus.className = 'exp-status not-met';
        }
    };

    const render = () => {
        // æ¸²æŸ“èŒä¸šçŠ¶æ€
        renderClassStatus();
        
        // æ¸²æŸ“ææ–™åˆ—è¡¨
        renderMaterials();
        
        // æ›´æ–°UIçŠ¶æ€
        dom.moneyCheck.checked = state.moneyChecked;
        dom.fragments.value = state.fragments;
        dom.scrolls.value = state.scrolls;
        updateExpStatus();
    };
    
    const renderClassStatus = () => {
        const expMet = dom.expStatus.textContent === 'å·²æ»¡è¶³';
        
        // æ£€æŸ¥é€šç”¨ææ–™æ˜¯å¦å…¨éƒ¨æ»¡è¶³
        const generalMaterials = materialsData.filter(m => m.class === 'é€šç”¨');
        const allGeneralMet = generalMaterials.every(material => {
            return state.materials[material.id];
        });
        
        // åŸºç¡€æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼ˆé‡‘é’±+ç»éªŒ+é€šç”¨ææ–™ï¼‰
        const baseConditionsMet = state.moneyChecked && expMet && allGeneralMet;
        
        // ç”ŸæˆèŒä¸šçŠ¶æ€HTML
        dom.classStatus.innerHTML = classes.map(className => {
            // è·å–è¯¥èŒä¸šçš„ä¸“å±ææ–™
            const classMaterials = materialsData.filter(m => m.class === className);
            const allClassMaterialsMet = classMaterials.every(material => {
                return state.materials[material.id];
            });
            
            const statusClass = baseConditionsMet && allClassMaterialsMet ? 'ready' : 'pending';
            const statusText = baseConditionsMet && allClassMaterialsMet ? 'å¯æ»¡çº§' : 'å¾…æ²‰æ·€';
            
            return `
                <div class="class-row">
                    <div class="class-name">${className}</div>
                    <div class="class-indicator ${statusClass}">${statusText}</div>
                </div>
            `;
        }).join('');
    };
    
    const renderMaterials = () => {
        dom.materialsList.innerHTML = materialsData.map(material => {
            const checked = state.materials[material.id] ? 'checked' : '';
            return `
                <div class="resource-item">
                    <div class="resource-name">${material.name}</div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="${material.id}-check" ${checked}>
                    </div>
                </div>
            `;
        }).join('');
    };

    const saveAndRender = () => {
        saveData();
        render();
    };

    const saveData = async () => {
        try {
            // å…ˆä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem(config.storageKey, JSON.stringify(state));
            
            // å¦‚æœæœ‰GitHub tokenï¼Œåˆ™å°è¯•ä¿å­˜åˆ°Gist
            if (!config.gistToken || config.gistToken === 'YOUR_GITHUB_TOKEN_HERE') {
                console.log('æœªé…ç½®GitHub Tokenï¼Œä»…ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                return;
            }
            
            const url = config.gistId 
                ? `https://api.github.com/gists/${config.gistId}` 
                : 'https://api.github.com/gists';
                
            const response = await fetch(url, {
                method: config.gistId ? 'PATCH' : 'POST',
                headers: {
                    'Authorization': `token ${config.gistToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    description: 'Secret Agent Resources Data',
                    public: false,
                    files: {
                        [config.gistFilename]: {
                            content: JSON.stringify(state)
                        }
                    }
                })
            });
            
            const data = await response.json();
            if (!config.gistId) {
                config.gistId = data.id;
                localStorage.setItem('gistId', data.id);
            }
        } catch (e) {
            console.error('ä¿å­˜åˆ°Gistå¤±è´¥:', e);
            // å›é€€åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem(config.storageKey, JSON
